{% extends "base.html" %}

{% block title %}المفضلة - متجري الإلكتروني{% endblock %}

{% block content %}
<section class="py-5">
    <div class="container">
        <h2 class="text-center mb-5">منتجاتك المفضلة</h2>

        {% if products %}
        <div class="row">
            {% for product in products %}
            <div class="col-lg-4 col-md-6 mb-4 wishlist-card">
                <div class="card product-card h-100">
                    <div class="card-img-wrapper">
                        <img src="{{ url_for('static', filename=product.image_url) }}" class="card-img-top" alt="{{ product.name }}">
                        {% if not product.in_stock %}
                        <div class="out-of-stock-overlay">
                            <span class="badge bg-danger">نفد المخزون</span>
                        </div>
                        {% endif %}
                    </div>
                    <div class="card-body d-flex flex-column">
                        <h5 class="card-title">{{ product.name }}</h5>
                        <p class="card-text text-muted">{{ product.description }}</p>
                        <span class="badge bg-secondary mb-2">{{ product.category }}</span>
                        <div class="mt-auto">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span class="h5 text-orange mb-0">{{ product.price }} ج.م</span>
                                <button class="btn btn-outline-secondary btn-sm wishlist-heart"  
                                        onclick="toggleWishlist({{ product.id }}, this)"  
                                        data-product-id="{{ product.id }}">
                                    <i class="fas fa-heart text-danger"></i>
                                </button>
                            </div>
                            <div class="d-grid">
                                {% if product.in_stock %}
                                <button class="btn btn-orange btn-sm" onclick="addToCart({{ product.id }})">
                                    <i class="fas fa-shopping-cart me-2"></i>أضف للسلة
                                </button>
                                {% else %}
                                <button class="btn btn-secondary btn-sm" disabled>
                                    <i class="fas fa-times me-2"></i>غير متوفر
                                </button>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <p class="text-center text-muted">لم تضف أي منتج للمفضلة بعد.</p>
        {% endif %}
    </div>
<script>
document.addEventListener('DOMContentLoaded', () => {
    // نفذ الكود فقط لو الصفحة هي wishlist
    if (document.body.dataset.page !== 'wishlist') return;

    // دالة toggleWishlist خاصة بالمفضلة
    function toggleWishlist(productId, el) {
        fetch('/wishlist/toggle', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ product_id: productId })
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                const card = el.closest('.wishlist-card');
                if (card) {
                    card.style.transition = "opacity 0.5s ease";
                    card.style.opacity = 0;
                    setTimeout(() => card.remove(), 500);
                }
                showNotification(data.message, 'success');
            } else {
                showNotification(data.message || 'حدث خطأ', 'error');
            }
        })
        .catch(err => {
            console.log(err);
            showNotification('حدث خطأ في الاتصال', 'error');
        });
    }

    // تلوين القلوب عند تحميل الصفحة
    const hearts = document.querySelectorAll('.wishlist-heart i');
    hearts.forEach(icon => icon.classList.add('text-danger'));

    // إرفاق حدث toggle لكل زر
    const buttons = document.querySelectorAll('.wishlist-heart');
    buttons.forEach(btn => {
        btn.addEventListener('click', (e) => toggleWishlist(btn.dataset.productId, btn));
    });
});
</script>

</section>
{% endblock %}
